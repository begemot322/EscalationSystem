<!DOCTYPE html>
<html lang="ru">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <title>Создать эскалацию | WaveForm</title>
    <link rel="icon" href="../assets/images/waveform.png" type="image/x-icon" />
  </head>

  <body>

  <div class="container mt-4">
    <h2 class="mb-4">Создать эскалацию</h2>

    <div id="message-container" class="mb-3"></div>

    <form id="escalation-form" class="border p-4 rounded">

      <div class="mb-3">
        <label class="form-label">Название</label>
        <input type="text" class="form-control" id="name" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Описание</label>
        <textarea class="form-control" id="description" rows="3" required></textarea>
      </div>

      <div class="mb-3">

        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Ответственные</label>
            <div class="input-group mb-2">
              <input type="text" class="form-control" id="userSearch"
                     placeholder="Поиск по имени...">
              <button type="button" class="btn btn-outline-secondary mx-1" onclick="handleSearch()">
                <i class="bi bi-search"></i> Поиск
              </button>
            </div>
            <small id="searchInfo" class="text-muted">Загрузка пользователей...</small>
          </div>
        </div>

        <select class="form-select" id="responsibleUserIds" multiple size="7" required>
          <option value="">Загрузка пользователей...</option>
        </select>
        <small class="text-muted">Удерживайте Ctrl для выбора нескольких пользователей</small>

        <div class="row">
          <div class="col-md-3">
            <div class="d-flex justify-content-between mb-3">
              <div class="btn-group">
                <button type="button" class="btn btn-outline-light" id="prevPage" disabled>
                  <i class="bi bi-arrow-left"></i> Назад
                </button>
                <button type="button" class="btn btn-outline-light mx-2" id="nextPage" disabled>
                  Вперед <i class="bi bi-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <button type="submit" class="btn btn-dark">
        <i class="bi bi-plus-circle"></i> Создать эскалацию
      </button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initApp } from '../js/main.js';
    import {
      initUsersList,
      handleSearch,
      nextPage,
      prevPage,
      handleCreateEscalation
    } from '../js/escalation/handlers/create-handler.js';

    document.addEventListener('DOMContentLoaded', async () => {
      // Инициализируем header и footer
      await initApp();

      // Загружаем пользователей
      await initUsersList();

      // Обработчик отправки формы
      const form = document.getElementById('escalation-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleCreateEscalation();
      });

      // Добавляем обработчики для кнопок пагинации
      document.getElementById('nextPage').addEventListener('click', async () => {
        await nextPage();
      });

      document.getElementById('prevPage').addEventListener('click', async () => {
        await prevPage();
      });

      // Добавляем обработчик для кнопки поиска
      document.querySelector('.btn-outline-secondary').addEventListener('click', async () => {
        await handleSearch();
      });

      // Поиск при нажатии Enter
      document.getElementById('userSearch').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          await handleSearch();
        }
      });
    });
  </script>
</body>
</html>